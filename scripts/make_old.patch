From 764f1c8c3cd7f60df1f959880303adc3c0406b4c Mon Sep 17 00:00:00 2001
From: Stephen Moore <stephen@delfick.com>
Date: Sat, 30 Mar 2024 11:11:24 +1100
Subject: [PATCH] fixup: Make mypy pass on older django-stubs/mypy

---
 extended_mypy_django_plugin/plugin/_hook.py                | 4 ++--
 extended_mypy_django_plugin/plugin/actions/_sem_analyze.py | 4 ++--
 mypy.ini                                                   | 3 +--
 tools/venv                                                 | 2 +-
 4 files changed, 6 insertions(+), 7 deletions(-)

diff --git a/extended_mypy_django_plugin/plugin/_hook.py b/extended_mypy_django_plugin/plugin/_hook.py
index 5a0916d..c12f4c6 100644
--- a/extended_mypy_django_plugin/plugin/_hook.py
+++ b/extended_mypy_django_plugin/plugin/_hook.py
@@ -2,7 +2,7 @@ from __future__ import annotations
 
 import abc
 from collections.abc import Callable
-from typing import Generic, TypeAlias, TypeVar, overload
+from typing import Generic, TypeAlias, TypeVar, cast, overload
 
 from mypy.plugin import Plugin
 
@@ -66,7 +66,7 @@ class hook(Generic[T_Plugin, T_Ctx, T_Ret]):
 
         def hook(fullname: str) -> Callable[[T_Ctx], T_Ret] | None:
             return self.hook(
-                plugin=instance,
+                plugin=cast(T_Plugin, instance),
                 fullname=fullname,
                 super_hook=super_hook(fullname),
             ).hook()
diff --git a/extended_mypy_django_plugin/plugin/actions/_sem_analyze.py b/extended_mypy_django_plugin/plugin/actions/_sem_analyze.py
index bd0a843..5adf443 100644
--- a/extended_mypy_django_plugin/plugin/actions/_sem_analyze.py
+++ b/extended_mypy_django_plugin/plugin/actions/_sem_analyze.py
@@ -72,7 +72,7 @@ class SemAnalyzing:
             self.api.fail(f"No concrete children found for {parent.node.fullname}", ctx.call)
 
         if mypy_version_tuple >= (1, 4):
-            type_var_expr = TypeVarExpr(
+            type_var_expr = TypeVarExpr(  # type: ignore[call-arg]
                 name=name,
                 fullname=f"{self.api.cur_mod_id}.{name}",
                 values=list(values),
@@ -80,7 +80,7 @@ class SemAnalyzing:
                 default=AnyType(TypeOfAny.from_omitted_generics),
             )
         else:
-            type_var_expr = TypeVarExpr(  # type: ignore[call-arg]
+            type_var_expr = TypeVarExpr(
                 name=name,
                 fullname=f"{self.api.cur_mod_id}.{name}",
                 values=list(values),
diff --git a/mypy.ini b/mypy.ini
index 455b6f6..32a7f45 100644
--- a/mypy.ini
+++ b/mypy.ini
@@ -12,8 +12,7 @@ exclude = (?x)(
     )
 
 plugins =
-    extended_mypy_django_plugin.main,
-    mypy.plugins.proper_plugin
+    extended_mypy_django_plugin.main
 
 [mypy.plugins.django-stubs]
 django_settings_module = scripts.test_settings
diff --git a/tools/venv b/tools/venv
index 66477ce..f5d8599 100755
--- a/tools/venv
+++ b/tools/venv
@@ -19,7 +19,7 @@ manager.add_local_dep(
     "{here}",
     "..",
     version_file=("extended_mypy_django_plugin", "version.py"),
-    name="extended_mypy_django_plugin[stubs-latest,tests]=={version}",
+    name="extended_mypy_django_plugin[stubs-older,tests]=={version}",
 )
 
 manager.add_local_dep(
-- 
2.42.1

